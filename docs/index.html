<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantitative Momentum & Reversal Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        body {
            font-family: "Libre Baskerville", serif;
            background-color: #111827; /* Dark blue-gray */
            color: #d1d5db; /* Light gray */
        }
        .card {
            background-color: #1f2937; /* Lighter blue-gray */
            border: 1px solid #374151; /* Softer border */
            border-radius: 0.75rem; /* Slightly less rounded */
            padding: 1.25rem; /* A bit less padding */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        /* Improve input field appearance */
        input[type='number'], textarea {
            background-color: #374151; /* Darker input fields */
            border: 1px solid #4b5563;
        }
        input[type='range']::-webkit-slider-thumb { @apply slider-thumb; }
        input[type='range']::-moz-range-thumb { @apply slider-thumb; }
        .weight-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: #4b5563;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 2px;
        }
         .weight-slider::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            background: #60a5fa;
        }
        .gauge-bar {
            transition: transform 0.5s ease-out;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">

        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Quantitative Momentum & Reversal Simulator</h1>
            <p class="text-gray-400 mt-2">An advanced tool using calculus-based concepts and multiple weighted indicators.</p>
        </header>

        <div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 p-4 rounded-xl mb-8" role="alert">
            <p class="font-bold">Disclaimer</p>
            <p>This is a highly speculative, educational tool. It is not financial advice. No mathematical model can predict the market with certainty. Use at your own risk.</p>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div>
                <label for="presetStrategy" class="mr-2 font-semibold text-gray-300">Preset Strategy:</label>
                <select id="presetStrategy" class="bg-gray-800 border border-gray-600 rounded-lg p-2 text-gray-200">
                    <option value="custom">Custom</option>
                    <option value="momentum">Momentum</option>
                    <option value="meanreversion">Mean Reversion</option>
                    <option value="balanced">Balanced</option>
                </select>
            </div>
            <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow">Export Settings & Result</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:items-stretch">
            <div class="lg:col-span-3 space-y-6">
        
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Core Market Data</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="currentPrice" class="block text-sm font-medium text-gray-400">Current Stock Price (â‚¹)</label>
                            <input type="number" id="currentPrice" value="1000" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="scalingFactor" class="block text-sm font-medium text-gray-400" title="Adjusts the overall sensitivity of the prediction.">Prediction Sensitivity</label>
                            <input type="number" id="scalingFactor" value="4" step="0.5" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
        
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-white">ðŸ§  Smart Analyst</h2>
                    <p class="text-gray-400 mb-2 text-sm">Paste a financial news article or analysis below. The AI will interpret it, provide advice, and suggest a strategy by setting the indicator weights for you.</p>
                    <textarea id="articleInput" class="w-full h-32 bg-gray-900 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="Paste news article text here..."></textarea>
                
                    <div class="mt-3">
                        <label for="imageUpload" class="block text-sm font-medium text-gray-400">Optional: Upload an image (chart, etc.)</label>
                        <input type="file" id="imageUpload" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" multiple>
                    </div>
                
                    <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                        <img id="imagePreview" src="#" alt="Uploaded Image" style="width: 40px; height: 40px; border: 1px solid gray;">
                        <p id="imageUploadNotification" class="text-gray-400 text-xs italic">Image uploaded</p>
                    </div>
                
                    <button id="analyzeBtn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow">
                        Analyze & Set Strategy
                    </button>
                    <div id="aiAdvice" class="mt-4 p-3 bg-gray-900/50 rounded-lg text-gray-300 text-sm" style="display: none;">
                    </div>
                </div>
                <div class="card space-y-6" id="indicator-controls">
                    </div>
        
            </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2 space-y-6 flex flex-col">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-white">Combined Signal</h2>
                    <div class="relative w-full h-24">
                        <div class="w-full h-8 bg-gradient-to-r from-red-500 via-gray-500 to-green-500 rounded-full absolute top-1/2 -translate-y-1/2"></div>
                        <div id="gauge-needle" class="absolute top-1/2 h-10 w-1 bg-white rounded-full origin-bottom" style="left: 50%; transform: rotate(0deg);"></div>
                    </div>
                    <div id="finalSignalText" class="text-center text-2xl font-bold mt-4">NEUTRAL</div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-white">Prediction Output</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-baseline p-3 bg-gray-900 rounded-lg">
                            <span class="text-gray-400">Predicted Change:</span>
                            <span id="predictedChange" class="text-xl font-semibold text-gray-300">â‚¹0.00 (0.00%)</span>
                        </div>
                        <div class="flex justify-between items-baseline p-4 bg-black/30 rounded-lg">
                            <span class="text-gray-300 text-lg">Predicted Price:</span>
                            <span id="predictedPrice" class="text-3xl font-bold text-white">â‚¹1000.00</span>
                        </div>
                    </div>
                </div>

                <div class="card flex-grow flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-white">AI Analyst Commentary</h2>
                    <p id="analystCommentary" class="text-gray-400 text-sm flex-grow">Adjust inputs to generate an analysis.</p>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-white">Indicator Contributions</h2>
                    <ul id="indicatorContributions" class="space-y-2 text-sm"></ul>
                </div>
            </div>

        </div>
    </div>
    
    <template id="indicator-template">
        <div>
            <div class="flex justify-between items-center">
                <h3 class="indicator-name text-lg font-medium text-white">Indicator Name</h3>
                <div class="text-right">
                    <span class="indicator-signal-text text-sm font-bold">NEUTRAL</span>
                </div>
            </div>
            <div class="mt-3 space-y-3 indicator-inputs">
                <!-- Dynamic inputs go here -->
            </div>
             <div class="mt-4">
                <label class="block text-xs font-medium text-gray-400 mb-1">Weight: <span class="indicator-weight-value font-bold">0.0</span></label>
                <input type="range" class="weight-slider indicator-weight" min="0" max="1" step="0.05" value="0.5">
            </div>
        </div>
    </template>

    <script>
    // In your index.html script tag

    document.addEventListener('DOMContentLoaded', () => {

    // --- VARIABLE DECLARATIONS (All in one place) ---
        const chatIcon = document.getElementById('chat-icon');
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chatInput');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        // NOTE: We no longer need single imagePreview and imageUploadNotification variables
        
        // --- CHATBOT EVENT LISTENERS ---
        chatIcon.addEventListener('click', () => {
            chatWindow.classList.toggle('hidden');
        });
    
        chatInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && chatInput.value.trim() !== '') {
                const userQuery = chatInput.value;
                appendMessage('user', userQuery);
                chatInput.value = ''; // Clear input

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: userQuery })
                    });
                    const data = await response.json();
                    appendMessage('bot', data.reply);
                } catch (error) {
                    appendMessage('bot', 'Sorry, I encountered an error. Please try again.');
                }
            }
        });
        
        const imagePreview = document.getElementById('imagePreview');
        const imageUploadNotification = document.getElementById('imageUploadNotification');

        // --- IMAGE UPLOAD EVENT LISTENER (Single correct version for multiple images) ---
        imageUpload.addEventListener('change', () => {
            imagePreviewContainer.innerHTML = ''; // Clear previous previews
            imagePreviewContainer.style.display = 'none';

            const files = imageUpload.files;
            if (files && files.length > 0) {
                imagePreviewContainer.style.display = 'flex';
                imagePreviewContainer.style.flexWrap = 'wrap';
                imagePreviewContainer.style.gap = '8px';

                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target?.result;
                        img.alt = 'Uploaded Image';
                        img.style.width = '40px';
                        img.style.height = '40px';
                        img.style.objectFit = 'cover';
                        img.style.border = '1px solid gray';
                        img.style.borderRadius = '4px';
                        imagePreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // New handler for multiple images
imageUpload.addEventListener('change', () => {
    imagePreviewContainer.innerHTML = ''; // Clear previous previews
    imagePreviewContainer.style.display = 'none';

    const files = imageUpload.files;
    if (files && files.length > 0) {
        imagePreviewContainer.style.display = 'flex'; // Use flexbox for thumbnails
        imagePreviewContainer.style.flexWrap = 'wrap';
        imagePreviewContainer.style.gap = '8px';

        for (const file of files) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target?.result;
                img.alt = 'Uploaded Image';
                img.style.width = '40px';
                img.style.height = '40px';
                img.style.objectFit = 'cover';
                img.style.border = '1px solid gray';
                img.style.borderRadius = '4px';
                imagePreviewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }
});
    
    function appendMessage(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('mb-3', 'p-3', 'rounded-lg');
        if (sender === 'user') {
            messageDiv.classList.add('bg-blue-600', 'text-white', 'ml-auto', 'max-w-[80%]');
        } else {
            messageDiv.classList.add('bg-gray-700', 'text-gray-200', 'mr-auto', 'max-w-[80%]');
        }
        messageDiv.innerText = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
    }

        const INDICATOR_CONFIG = {
            rsi: {
                name: 'RSI (Momentum)',
                weight: 0.25,
                inputs: [
                    { id: 'rsiValue', label: 'RSI Value', type: 'range', min: 0, max: 100, step: 1, value: 50 },
                ],
                calculateSignal: (inputs) => {
                    const rsi = inputs.rsiValue;
                    if (rsi > 80) return -Math.min(1, (rsi - 80) / 10);
                    if (rsi < 20) return Math.min(1, (20 - rsi) / 10);
                    if (rsi > 50) return -(((rsi - 50) ** 2) / 30);
                    if (rsi < 50) return (((50 - rsi) ** 2) / 30);
                    return 0;
                }
            },
            stochastic: {
                name: 'Stochastic Oscillator (Reversal)',
                weight: 0.15,
                inputs: [
                    { id: 'stochK', label: '%K Value', type: 'range', min: 0, max: 100, step: 1, value: 50 },
                ],
                calculateSignal: (inputs) => {
                    const k = inputs.stochK;
                    if (k > 80) return -Math.min(1, (k - 80) / 15);
                    if (k < 20) return Math.min(1, (20 - k) / 15);
                    return (k - 50) / 50;
                }
            },
            macd: {
                name: 'MACD (Trend)',
                weight: 0.20,
                inputs: [
                    { id: 'macdLine', label: 'MACD Line', type: 'number', step: 0.05, value: 0.5 },
                    { id: 'signalLine', label: 'Signal Line', type: 'number', step: 0.05, value: 0.3 },
                ],
                calculateSignal: (inputs) => {
                    const hist = inputs.macdLine - inputs.signalLine;
                    const scale = 2;
                    return Math.max(-1, Math.min(1, hist / scale));
                }
            },
            ma_slope: {
                name: 'MA Slope (Calculus-based Trend)',
                weight: 0.20,
                inputs: [
                    { id: 'maCurrent', label: 'Current MA Value', type: 'number', step: 1, value: 995 },
                    { id: 'maPrevious', label: 'Previous MA Value', type: 'number', step: 1, value: 994 },
                ],
                calculateSignal: (inputs) => {
                    const price = parseFloat(document.getElementById('currentPrice').value) || 1;
                    const slope = inputs.maCurrent - inputs.maPrevious;
                    const relativeSlope = slope / price; 
                    const scale = 0.002;
                    return Math.max(-1, Math.min(1, relativeSlope / scale));
                }
            },
            bollinger: {
                name: 'Bollinger Bands (Volatility Reversal)',
                weight: 0.10,
                inputs: [
                    { id: 'bbLower', label: 'Lower Band', type: 'number', step: 1, value: 980 },
                    { id: 'bbUpper', label: 'Upper Band', type: 'number', step: 1, value: 1020 },
                ],
                calculateSignal: (inputs) => {
                    const price = parseFloat(document.getElementById('currentPrice').value);
                    const { bbLower, bbUpper } = inputs;
                    if (bbUpper <= bbLower) return 0;
                    const mid = (bbUpper + bbLower) / 2;
                    const range = (bbUpper - mid);
                    if (range === 0) return 0;
                    const position = (price - mid) / range;
                    return -Math.max(-1, Math.min(1, position));
                }
            },
             obv: {
                name: 'On-Balance Volume (Volume Pressure)',
                weight: 0.10,
                inputs: [
                    { id: 'obvChange', label: 'Recent OBV Change (%)', type: 'number', step: 0.1, value: 0.5 },
                ],
                calculateSignal: (inputs) => {
                    const change = inputs.obvChange;
                    const scale = 2;
                    return Math.max(-1, Math.min(1, change / scale));
                }
            }
        };

        const PRESET_STRATEGIES = {
            custom: {},
            momentum: {
                rsi: 0.35,
                stochastic: 0.15,
                macd: 0.25,
                ma_slope: 0.2,
                bollinger: 0.03,
                obv: 0.02
            },
            meanreversion: {
                rsi: 0.15,
                stochastic: 0.25,
                macd: 0.1,
                ma_slope: 0.1,
                bollinger: 0.3,
                obv: 0.1
            },
            balanced: {
                rsi: 0.2,
                stochastic: 0.2,
                macd: 0.2,
                ma_slope: 0.2,
                bollinger: 0.1,
                obv: 0.2
            }
        };

        const controlsContainer = document.getElementById('indicator-controls');
        const template = document.getElementById('indicator-template');

        // Dynamically create controls for each indicator
        for (const key in INDICATOR_CONFIG) {
            const config = INDICATOR_CONFIG[key];
            const clone = template.content.cloneNode(true);

            clone.querySelector('.indicator-name').textContent = config.name;
            clone.querySelector('.indicator-weight').value = config.weight;
            clone.querySelector('.indicator-weight-value').textContent = config.weight.toFixed(2);
            clone.querySelector('.indicator-weight').dataset.indicator = key;
            
            const inputsContainer = clone.querySelector('.indicator-inputs');
            
            const row = document.createElement('div');
            row.className = 'grid grid-cols-2 gap-x-4 gap-y-2';

            config.inputs.forEach(inputConfig => {
                const group = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = inputConfig.id;
                label.className = 'block text-sm font-medium text-gray-400';
                label.textContent = inputConfig.label;
                
                const input = document.createElement('input');
                input.type = inputConfig.type;
                input.id = inputConfig.id;
                input.min = inputConfig.min;
                input.max = inputConfig.max;
                input.step = inputConfig.step;
                input.value = inputConfig.value;
                input.dataset.indicator = key;
                input.className = 'mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500';

                if(inputConfig.type === 'range') {
                    const valueDisplay = document.createElement('span');
                    valueDisplay.id = `${inputConfig.id}Value`;
                    valueDisplay.textContent = ` (${inputConfig.value})`;
                    valueDisplay.className = 'text-xs text-gray-400';
                    label.appendChild(valueDisplay);
                    input.className = 'w-full h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer';
                    input.classList.remove('p-2', 'mt-1');
                }

                group.appendChild(label);
                group.appendChild(input);
                row.appendChild(group);
            });
            inputsContainer.appendChild(row);
            controlsContainer.appendChild(clone);
        }
        
        // --- REVISED Main Update Function ---
        async function updatePrediction() {
            const commentaryEl = document.getElementById('analystCommentary');
            commentaryEl.textContent = 'ðŸ¤– Generating AI analysis...'; // Loading state
        
            // 1. Collect all data for the backend
            const payload = {
                core: {
                    currentPrice: parseFloat(document.getElementById('currentPrice').value),
                    scalingFactor: parseFloat(document.getElementById('scalingFactor').value)
                },
                indicators: {}
            };
        
            let totalWeight = 0;
            document.querySelectorAll('.indicator-weight').forEach(weightSlider => {
                const key = weightSlider.dataset.indicator;
                const config = INDICATOR_CONFIG[key];
                const weight = parseFloat(weightSlider.value);
                totalWeight += weight;
            
                payload.indicators[key] = {
                    weight: weight,
                    inputs: {}
                };
            
                config.inputs.forEach(inputConfig => {
                    payload.indicators[key].inputs[inputConfig.id] = parseFloat(document.getElementById(inputConfig.id).value);
                });
            });
            payload.core.totalWeight = totalWeight;
        
        
            // 2. Call the Flask backend API
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
            
                const data = await response.json();
            
                // 3. Update UI with data from the server
                updateResultsUI(data.combined_signal, data.predicted_change_value, data.predicted_change_percentage, data.predicted_price);
                updateIndicatorContributions(data.contributions);
            
                // This now comes directly from Gemini via your backend!
                commentaryEl.textContent = data.explanation;
            
            } catch (error) {
                console.error("Prediction failed:", error);
                commentaryEl.textContent = `Error: Could not fetch prediction. ${error.message}`;
            }
        }

        // --- UI Update Helpers ---
        function getSignalLabel(signal) {
            if (signal > 0.7) return 'Strong Buy';
            if (signal > 0.2) return 'Buy';
            if (signal < -0.7) return 'Strong Sell';
            if (signal < -0.2) return 'Sell';
            return 'Neutral';
        }
        
        function getSignalColor(signal) {
             if (signal > 0.7) return '#10B981';
            if (signal > 0.2) return '#34D399';
            if (signal < -0.7) return '#EF4444';
            if (signal < -0.2) return '#F87171';
            return '#9CA3AF';
        }

        function updateResultsUI(signal, changeValue, changePercent, finalPrice) {
            // Update Gauge
            const needle = document.getElementById('gauge-needle');
            const rotation = signal * 90;
            needle.style.transform = `rotate(${rotation}deg)`;

            document.getElementById('finalSignalText').textContent = getSignalLabel(signal).toUpperCase();
            document.getElementById('finalSignalText').style.color = getSignalColor(signal);

            // Update Prediction Text
            const changeEl = document.getElementById('predictedChange');
            changeEl.textContent = `â‚¹${changeValue.toFixed(2)} (${changePercent.toFixed(2)}%)`;
            if (changeValue >= 0) {
                changeEl.style.color = '#34D399';
            } else {
                changeEl.style.color = '#F87171';
            }
            document.getElementById('predictedPrice').textContent = `â‚¹${finalPrice.toFixed(2)}`;
        }

        // function updateAnalystCommentary(contributions, finalSignal) {
        //     const commentaryEl = document.getElementById('analystCommentary');
        //     if(finalSignal === 0) {
        //         commentaryEl.textContent = 'The model shows no clear directional bias. All indicators are either neutral or cancelling each other out.';
        //         return;
        //     }

        //     const sorted = contributions.filter(c => c.weight > 0).sort((a,b) => Math.abs(b.signal * b.weight) - Math.abs(a.signal * a.weight));
            
        //     const primaryDriver = sorted[0];
        //     const secondaryDriver = sorted.length > 1 ? sorted[1] : null;

        //     const finalLabel = getSignalLabel(finalSignal).toLowerCase();
        //     let text = `The overall signal is moderately ${finalLabel}. `;
        //     if(Math.abs(finalSignal) > 0.7) text = `The overall signal is strongly ${finalLabel}. `;
            
        //     text += `This is primarily driven by a ${getSignalLabel(primaryDriver.signal).toLowerCase()} signal from the ${primaryDriver.name.split('(')[0].trim()}. `;
            
        //     if(secondaryDriver && Math.abs(secondaryDriver.signal) > 0.3) {
        //         text += `This is supported by a notable ${getSignalLabel(secondaryDriver.signal).toLowerCase()} signal from the ${secondaryDriver.name.split('(')[0].trim()}.`
        //     }
        //     commentaryEl.textContent = text;
        // }

        function updateIndicatorContributions(contributions) {
            const ul = document.getElementById('indicatorContributions');
            ul.innerHTML = '';
            contributions.forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-semibold" style="color:${getSignalColor(c.signal)}">${getSignalLabel(c.signal)}</span> <span class="text-gray-400">(${c.name})</span> <span class="ml-2 text-gray-500">Weight: ${c.weight.toFixed(2)}</span>`;
                ul.appendChild(li);
            });
        }

        // --- Preset Strategies ---
        document.getElementById('presetStrategy').addEventListener('change', function() {
            const preset = this.value;
            if (preset === 'custom') return;
            const weights = PRESET_STRATEGIES[preset];
            document.querySelectorAll('.indicator-weight').forEach(slider => {
                const key = slider.dataset.indicator;
                if (weights[key] !== undefined) {
                    slider.value = weights[key];
                    slider.previousElementSibling.querySelector('.indicator-weight-value').textContent = weights[key].toFixed(2);
                }
            });
            updatePrediction();
        });
        // --- Event Listeners ---
        // Use a debounce function to avoid spamming the API on every tiny slider move

        // --- Export/Save Feature ---
        document.getElementById('exportBtn').addEventListener('click', function() {
            const settings = {};
            document.querySelectorAll('.indicator-weight').forEach(slider => {
                const key = slider.dataset.indicator;
                settings[key] = {
                    weight: parseFloat(slider.value),
                    inputs: {}
                };
                const config = INDICATOR_CONFIG[key];
                config.inputs.forEach(inputConfig => {
                    settings[key].inputs[inputConfig.id] = parseFloat(document.getElementById(inputConfig.id).value);
                });
            });
            settings.currentPrice = parseFloat(document.getElementById('currentPrice').value);
            settings.scalingFactor = parseFloat(document.getElementById('scalingFactor').value);
            settings.preset = document.getElementById('presetStrategy').value;
            settings.timestamp = new Date().toISOString();
            settings.predictedChange = document.getElementById('predictedChange').textContent;
            settings.predictedPrice = document.getElementById('predictedPrice').textContent;
            settings.analystCommentary = document.getElementById('analystCommentary').textContent;

            const blob = new Blob([JSON.stringify(settings, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock_prediction_${settings.timestamp.replace(/[:.]/g,'_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        let debounceTimer;
        document.body.addEventListener('input', (e) => {
            if (e.target.matches('input')) {
                // Update range slider text displays instantly
                if(e.target.type === 'range' && !e.target.classList.contains('weight-slider')) {
                    const display = document.getElementById(`${e.target.id}Value`);
                    if(display) display.textContent = ` (${e.target.value})`;
                }
                if(e.target.classList.contains('weight-slider')) {
                    const display = e.target.previousElementSibling.querySelector('.indicator-weight-value');
                    if(display) display.textContent = parseFloat(e.target.value).toFixed(2);
                }
            
                // Debounce the API call
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updatePrediction();
                }, 500); // Wait 500ms after the user stops changing inputs
            }
        });

       
         // --- "ANALYZE & SET STRATEGY" BUTTON EVENT LISTENER ---
         document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const articleText = document.getElementById('articleInput').value;
            const imageFiles = document.getElementById('imageUpload').files;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const adviceDiv = document.getElementById('aiAdvice');

            if (!articleText.trim() && imageFiles.length === 0) {
                alert('Please paste some text or upload image(s) to analyze.');
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';
            adviceDiv.style.display = 'none';

            const formData = new FormData();
            formData.append('text', articleText);

            for (const file of imageFiles) {
                formData.append('images', file);
            }

            try {
                const response = await fetch('/analyze-text', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to get analysis from server.');

                const data = await response.json();

                adviceDiv.textContent = `AI Advice: ${data.advice}`;
                adviceDiv.style.display = 'block';

                for (const key in data.weights) {
                    const slider = document.querySelector(`.indicator-weight[data-indicator="${key}"]`);
                    if (slider) {
                        slider.value = data.weights[key];
                        slider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            } catch (error) {
                adviceDiv.textContent = `Error: ${error.message}`;
                adviceDiv.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze & Set Strategy';
            }
        });

        // Update presets instantly
        document.getElementById('presetStrategy').addEventListener('change', function() {
            const preset = this.value;
            if (preset === 'custom') return;
            const weights = PRESET_STRATEGIES[preset];
            document.querySelectorAll('.indicator-weight').forEach(slider => {
                const key = slider.dataset.indicator;
                if (weights[key] !== undefined) {
                    slider.value = weights[key];
                    slider.previousElementSibling.querySelector('.indicator-weight-value').textContent = weights[key].toFixed(2);
                }
            });
            updatePrediction(); // Trigger prediction after applying preset
        });
        
        // Initial Calculation
        updatePrediction();
    });
    </script>
    <div id="chat-icon" class="fixed bottom-5 right-5 bg-blue-600 p-3 rounded-full cursor-pointer shadow-lg hover:bg-blue-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
    </div>

    <div id="chat-window" class="hidden fixed bottom-20 right-5 w-96 h-[500px] bg-gray-800 rounded-xl shadow-2xl flex flex-col">
        <div class="p-4 bg-gray-900 rounded-t-xl text-white font-semibold">FinBot Assistant</div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto"></div>
        <div class="p-4 border-t border-gray-700">
            <input type="text" id="chatInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" placeholder="Ask a question...">
        </div>
    </div>
</body>
</html> 